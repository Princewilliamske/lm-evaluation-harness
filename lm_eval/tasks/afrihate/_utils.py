import argparse
import yaml
from pathlib import Path

# List of African languages for AfriHate
LANGUAGES = [
    "amh", "arq", "ary", "hau", "ibo", "kin",
    "orm", "pcm", "som", "swa", "tir", "twi",
    "xho", "yor", "zul"
]

def gen_lang_yamls(output_dir: str, overwrite: bool) -> None:
    """
    Generate a YAML file for each language and a merged multilingual YAML.
    """
    output_path = Path(output_dir)
    output_path.mkdir(parents=True, exist_ok=True)

    # Keep track of generated language YAMLs
    include_files = []

    # --- Generate individual language YAMLs ---
    for lang in LANGUAGES:
        file_name = f"afrihate_{lang}_hate.yaml"
        file_path = output_path / file_name
        include_files.append(file_name)

        if file_path.exists() and not overwrite:
            continue  # skip if file exists

        yaml_content = {
            "task": f"afrihate_{lang}_hate",
            "dataset_path": "afrihate/afrihate",
            "dataset_name": lang,
            "output_type": "multiple_choice",
            "test_split": "test",
            "doc_to_text": "Tweet: {{text}}\nClassify as normal, abusive, or hate:\n",
            "doc_to_choice": ["normal", "abusive", "hate"],
            "doc_to_target": (
                '{{ "normal" if "normal" in label.lower() or "neutral" in label.lower() '
                'else "abusive" if "abuse" in label.lower() or "offensive" in label.lower() '
                'else "hate" }}'
            ),
            "metric_list": [
                {
                    "metric": "acc",
                    "aggregation": "mean",
                    "higher_is_better": True
                }
            ]
        }

        with open(file_path, "w", encoding="utf8") as f:
            f.write("# Generated by utils.py\n")
            yaml.dump(yaml_content, f, allow_unicode=True)
        print(f"Generated {file_name}")

    # --- Generate merged multilingual YAML ---
    multilingual_file = output_path / "afrihate_all_hate.yaml"

    if multilingual_file.exists() and not overwrite:
        print(f"{multilingual_file.name} already exists, skipping.")
        return

    multilingual_yaml = {
        "task": "afrihate_all_hate",
        "tag": "afrihate_all_languages",
        "dataset_path": "lm_eval/tasks/afrihate/afrihate_all_hate",  # Updated path
        "dataset_name": None,
        "test_split": "test",
        "doc_to_text": "Tweet: {{text}}\nClassify as normal, abusive, or hate:\n",
        "doc_to_choice": ["normal", "abusive", "hate"],
        "doc_to_target": (
            '{{ "normal" if "normal" in label.lower() or "neutral" in label.lower() '
            'else "abusive" if "abuse" in label.lower() or "offensive" in label.lower() '
            'else "hate" }}'
        ),
        "metric_list": [
            {
                "metric": "acc",
                "aggregation": "mean",
                "higher_is_better": True
            }
        ],
        "include": include_files,
        "metadata": {
            "description": "Balanced multilingual AfriHate task across 15 African languages.",
            "languages": LANGUAGES
        }
    }

    with open(multilingual_file, "w", encoding="utf8") as f:
        f.write("# Generated by utils.py\n")
        yaml.dump(multilingual_yaml, f, allow_unicode=True)
    print(f"Generated {multilingual_file.name}")


def main() -> None:
    """Parse CLI args and generate YAMLs."""
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--overwrite", default=False, action="store_true",
        help="Overwrite files if they already exist"
    )
    parser.add_argument(
        "--output-dir", default=".", help="Directory to write YAML files to"
    )
    args = parser.parse_args()

    gen_lang_yamls(output_dir=args.output_dir, overwrite=args.overwrite)


if __name__ == "__main__":
    main()
