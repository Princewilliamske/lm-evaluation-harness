import argparse
import yaml

LANGUAGES = [
    "amh", "arq", "ary", "hau", "ibo", "kin", "orm", "pcm", "som",
    "swa", "tir", "twi", "xho", "yor", "zul"
]

def gen_lang_yamls(output_dir: str, overwrite: bool) -> None:
    err = []
    for lang in LANGUAGES:
        file_name = f"afrihate_{lang}_hate.yaml"
        try:
            with open(
                f"{output_dir}/{file_name}", "w" if overwrite else "x", encoding="utf8"
            ) as f:
                f.write("# Generated by utils.py\n")
                yaml.dump(
                    {
                        "task": f"afrihate_{lang}_hate",
                        "dataset_path": "afrihate/afrihate",
                        "dataset_name": lang,
                        "output_type": "multiple_choice",
                        "eval_split": "test",  # Explicitly added
                        "doc_to_text": "Tweet: {{tweet}}\nClassify as normal, abusive, or hate:\n",
                        "doc_to_choice": ["normal", "abusive", "hate"],
                        "doc_to_target": '{{ "normal" if "normal" in label.lower() or "neutral" in label.lower() else "abusive" if "abuse" in label.lower() or "offensive" in label.lower() else "hate" }}',
                        "metric_list": [
                            {
                                "metric": "acc",
                                "aggregation": "mean",
                                "higher_is_better": True,
                            }
                        ],
                    },
                    f,
                    allow_unicode=True,
                )
        except FileExistsError:
            err.append(file_name)

    if err:
        raise FileExistsError(
            "Files already exist (use --overwrite): " + ", ".join(err)
        )

    # Generate multilingual YAML
    multilingual_file_name = "afrihate_multilingual_balanced_hate.yaml"
    include_files = [f"afrihate_{lang}_hate.yaml" for lang in LANGUAGES]

    try:
        with open(
            f"{output_dir}/{multilingual_file_name}", "w" if overwrite else "x", encoding="utf8"
        ) as f:
            f.write("# Generated by utils.py\n")
            yaml.dump(
                {
                    "include": include_files,
                    "task": "afrihate_multilingual_balanced_hate",
                    "tag": "afrihate_all_languages",
                    "eval_split": "test",  # Explicitly added for multilingual
                    "metadata": {
                        "description": "Balanced multilingual AfriHate task across 15 African languages.",
                        "languages": LANGUAGES,
                    },
                    "metric_list": [
                        {
                            "metric": "acc",
                            "aggregation": "mean",
                            "higher_is_better": True,
                        }
                    ],
                },
                f,
                allow_unicode=True,
            )
    except FileExistsError:
        raise FileExistsError(
            f"File already exists (use --overwrite): {multilingual_file_name}"
        )

def main() -> None:
    parser = argparse.ArgumentParser()
    parser.add_argument("--overwrite", default=False, action="store_true")
    parser.add_argument("--output-dir", default=".")
    args = parser.parse_args()
    gen_lang_yamls(output_dir=args.output_dir, overwrite=args.overwrite)

if __name__ == "__main__":
    main()
