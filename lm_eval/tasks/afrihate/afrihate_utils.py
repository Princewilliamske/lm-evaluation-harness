import argparse

import yaml


# Different languages that are part of AfriHate.
# These correspond to dataset names (Subsets) on HuggingFace.
# A yaml file is generated by this script for each language.

LANGUAGES = [
    "amh", "arq", "ary", "hau", "ibo", "kin", "orm", "pcm", "som", "swa", "tir", "twi", "xho", "yor", "zul"
]


def gen_lang_yamls(output_dir: str, overwrite: bool) -> None:
    """
    Generate a yaml file for each language.

    :param output_dir: The directory to output the files to.
    :param overwrite: Whether to overwrite files if they already exist.
    """
    err = []
    for lang in LANGUAGES:
        file_name = f"afrihate_{lang}_hate.yaml"
        try:
            with open(
                f"{output_dir}/{file_name}", "w" if overwrite else "x", encoding="utf8"
            ) as f:
                f.write("# Generated by utils.py\n")
                yaml.dump(
                    {
                        "task": f"afrihate_{lang}_hate",
                        "dataset_path": "afrihate/afrihate",
                        "dataset_name": lang,
                        "test_split": "test",
                        "output_type": "multiple_choice",
                        "doc_to_text": "Tweet: {{tweet}}\\nClassify as normal, abusive, or hate:\\n",
                        "doc_to_choice": ["normal", "abusive", "hate"],
                        "doc_to_target": "{{ \"normal\" if \"normal\" in label.lower() or \"neutral\" in label.lower() else \"abusive\" if \"abuse\" in label.lower() or \"offensive\" in label.lower() else \"hate\" }}",
                        "metric_list": [
                            {
                                "metric": "acc",
                                "aggregation": "mean",
                                "higher_is_better": True,
                            },
                            {
                                "metric": "f1",
                                "aggregation": "macro_f1",
                                "higher_is_better": True,
                            },
                        ],
                    },
                    f,
                    allow_unicode=True,
                )
        except FileExistsError:
            err.append(file_name)

    if len(err) > 0:
        raise FileExistsError(
            "Files were not created because they already exist (use --overwrite flag):"
            f" {', '.join(err)}"
        )

    # Generate the unifying multilingual YAML
    multilingual_file_name = "afrihate_multilingual_balanced_hate.yaml"
    include_files = [f"afrihate_{lang}_hate.yaml" for lang in LANGUAGES]
    try:
        with open(
            f"{output_dir}/{multilingual_file_name}", "w" if overwrite else "x", encoding="utf8"
        ) as f:
            f.write("# Generated by utils.py\n")
            yaml.dump(
                {
                    "include": include_files,
                    "task": "afrihate_multilingual_balanced_hate",
                    "tag": "afrihate_all_languages",
                    "metadata": {
                        "description": "Balanced multilingual AfriHate task across 15 African languages.",
                        "languages": LANGUAGES,
                    },
                    "metric_list": [
                        {
                            "metric": "acc",
                            "aggregation": "mean",
                            "higher_is_better": True,
                        },
                        {
                            "metric": "f1",
                            "aggregation": "macro_f1",
                            "higher_is_better": True,
                        },
                    ],
                },
                f,
                allow_unicode=True,
            )
    except FileExistsError:
        raise FileExistsError(
            f"File was not created because it already exists (use --overwrite flag): {multilingual_file_name}"
        )


def main() -> None:
    """Parse CLI args and generate language-specific yaml files."""
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--overwrite",
        default=False,
        action="store_true",
        help="Overwrite files if they already exist",
    )
    parser.add_argument(
        "--output-dir", default=".", help="Directory to write yaml files to"
    )
    args = parser.parse_args()

    gen_lang_yamls(output_dir=args.output_dir, overwrite=args.overwrite)


if __name__ == "__main__":
    main()